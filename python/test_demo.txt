#test_demo.py
#python 2.7
#Collect data from Socrate pulic dadta
################################# Send data as html by email #######
import smtplib
from email.MIMEMultipart import MIMEMultipart
from email.MIMEText import MIMEText
####################################################################
import psycopg2
import pandas as pd
from sqlalchemy import create_engine
from sqlalchemy.types import Date,String
import numpy as np
from sodapy import Socrata
import sys
reload(sys)
sys.setdefaultencoding('utf-8') 
############# load data  by API #################
client=Socrata("data-client", 
	"api_key",
	username="your_user_name", 
	password="your_password")
results=client.get('data-code',limit=300)
results_df=pd.DataFrame.from_records(results)
results_df=results_df[["action_type","applicant_name",
"address","application_date",
"application_permit_number","category"]]
################# data sample ###############################################
 action_type              address     applicant_name  \
0     ADD/ALT  11504 RIVIERA PL NE  BRAMHALL, MICHAEL   
1  DEMOLITION  11502 FREMONT AVE N    PEPPLE, LYNDSAY   
2         NEW     2116 ALKI AVE SW     HUMBLE, ROBERT   
3     ADD/ALT      1620 43RD AVE E   WILLIAMSON, BRAD   
4     ADD/ALT         2033 6TH AVE     BELCHER, CRAIG   

          application_date application_permit_number                category  \
0  2016-02-05T00:00:00.000                   6515018  SINGLE FAMILY / DUPLEX   
1  2017-07-25T00:00:00.000                   6609717  SINGLE FAMILY / DUPLEX   
2  2016-07-13T00:00:00.000                   6525740             MULTIFAMILY   
3  2015-02-06T00:00:00.000                   6456948             MULTIFAMILY   
4  2017-09-19T00:00:00.000                   6597061              COMMERCIAL   

        contractor                                        description  \
0              NaN  Repair in kind to deck accessory to single fam...   
1              NaN  Demolish an exsiting single family residence s...   
2              NaN  Establish use as and construct new multifamily...   
3  MERCER BUILDERS  CLOSED AS INCOMPLETE - EXPIRED PERMIT. Interio...   
4              NaN  Construct tenant improvements to existing comm...   

           expiration_date               final_date       ...        \
0  2017-08-05T00:00:00.000                      NaN       ...         
1  2019-01-25T00:00:00.000  2017-08-07T00:00:00.000       ...         
2  2019-02-05T00:00:00.000                      NaN       ...         
3  2016-08-06T00:00:00.000                      NaN       ...         
4                      NaN                      NaN       ...         

#############################################################################
################# create engine for database #####
#psycopg2
engine=create_engine('postgresql://username:password@host:port/database')
conn = engine.connect()
#conn.execute("SQL STATEMENT")
#########################################
###### Write dataframe into sql##########
#########################################
results_df.to_sql("seattle_demo",con=engine,\
	if_exists="replace",index = False,\
	dtype={'address': String, 
	'application_date': Date,
	'action_type': String,
	'applicant_name':String,
	'category':String,
	'application_permit_number':String})
#########################################
####### send data by email ##############
content=results_df.to_html()
Fromaddr="your_email_address"
toaddr="the_emali_address_send_to"
msg = MIMEMultipart()
msg['From']=Fromaddr
msg['To']=toaddr
msg['Subject']="Subject_For_the_Email"
#body="This is test demo"
msg.attach(MIMEText(content,'html')) ## make to be html 
Server=smtplib.SMTP('smtp for email account', email_port)
Server.starttls()
Server.login("your_email_address","your_password")
Server.sendmail(Fromaddr,toaddr,msg.as_string())
print ("Sent")
Server.quit()


